# 🎉 Vercel 部署方案总结

## 📋 核心问题解答

### ❓ 部署到 Vercel 如何实现数据存储？

**答案**: 使用 **Vercel KV (Redis)** 云数据库

#### 为什么不能用本地文件？

Vercel 是 **Serverless 无服务器架构**：
- ❌ 每次请求在不同的服务器上执行
- ❌ 函数执行完毕后，所有文件都会被清除
- ❌ 无法持久化存储文件
- ✅ 必须使用云数据库（如 Vercel KV）

#### 智能存储适配器

项目使用 `lib/storage-adapter.ts` 自动切换存储方式：

```typescript
// 自动检测环境
const isVercel = process.env.VERCEL === '1' || 
  (process.env.KV_REST_API_URL && 
   process.env.KV_REST_API_URL !== 'your_kv_rest_api_url_here');

// 动态选择存储方式
const storageModule = isVercel
  ? require('./storage')        // Vercel KV (生产环境)
  : require('./local-storage'); // 本地文件 (开发环境)
```

## 🚀 完整部署流程

### 1️⃣ 推送代码到 GitHub ✅

```bash
git push origin main
```

### 2️⃣ 在 Vercel 创建项目

1. 访问 https://vercel.com/dashboard
2. 点击 "Add New Project"
3. 选择 GitHub 仓库: `yanhuicsdn/news-investment-analyzer`
4. 配置项目（使用默认 Next.js 配置）

### 3️⃣ 配置环境变量

在 Vercel Settings → Environment Variables 添加：

```env
QWEN_API_KEY=sk-fefa9fed5599445abd3532c3b8187488
CRON_SECRET=your-random-secret-key  # 可选，用于定时任务安全验证
```

### 4️⃣ 添加 Vercel KV 数据库 ⭐ 最重要

1. 进入 Vercel 项目 → **Storage** 选项卡
2. 点击 **"Create Database"**
3. 选择 **"KV (Redis)"**
4. 创建并关联到项目

✅ **自动配置完成！** Vercel 会自动添加以下环境变量：
- `KV_URL`
- `KV_REST_API_URL`
- `KV_REST_API_TOKEN`
- `KV_REST_API_READ_ONLY_TOKEN`

### 5️⃣ 重新部署

点击 "Redeploy" 使环境变量生效

### 6️⃣ 初始化数据

访问你的应用，使用前端按钮：
1. 点击 **"抓取新闻"** 按钮
2. 点击 **"AI 分析"** 按钮
3. 查看分析结果

## 🤖 自动化方案

### 方案 1: Vercel Cron Jobs（推荐）

已配置在 `vercel.json` 中：

```json
{
  "crons": [{
    "path": "/api/cron/daily-update",
    "schedule": "0 13 * * *"  // 每天 21:00 北京时间
  }]
}
```

**功能**: 
- ✅ 每天自动抓取新闻
- ✅ 自动 AI 分析
- ✅ 自动保存到 Vercel KV
- ✅ 完全无需手动操作

**测试方法**:
```bash
curl https://your-app.vercel.app/api/cron/daily-update
```

### 方案 2: GitHub Actions

适合需要更长执行时间的场景，配置文件在 `.github/workflows/`

## 📊 数据存储详解

### Vercel KV 数据结构

```
Redis Sorted Set 结构：

news:{id}              → NewsItem 对象
news:by-date           → Sorted Set (按时间戳排序)

analysis:{newsId}      → InvestmentAnalysis 对象
analysis:by-date       → Sorted Set (按时间戳排序)
```

### 容量和费用

| 项目 | 免费额度 | 说明 |
|------|---------|------|
| **Vercel KV** | 256MB | 可存储 20,000-50,000 条记录 |
| **命令次数** | 30,000/月 | 足够日常使用 |
| **千问 API** | 按量计费 | 每月约 ¥30-60 |

## 🎯 三种使用方式

### 方式 1: 前端按钮（推荐）✨

在浏览器界面直接操作：
- 🟢 抓取新闻按钮
- 🟣 AI 分析按钮
- 🔵 刷新按钮

### 方式 2: 自动化定时任务

Vercel Cron Jobs 每天自动执行，无需干预

### 方式 3: 本地命令行

配置本地环境变量后：
```bash
npm run scrape
npm run analyze
```

数据会直接存储到 Vercel KV 云数据库

## 📚 相关文档

- **[VERCEL_DEPLOYMENT.md](./VERCEL_DEPLOYMENT.md)** - 详细部署指南
- **[CRON_SETUP.md](./CRON_SETUP.md)** - 定时任务配置
- **[README.md](./README.md)** - 项目说明

## ✅ 部署检查清单

- [ ] 代码已推送到 GitHub
- [ ] Vercel 项目已创建
- [ ] 环境变量已配置（QWEN_API_KEY）
- [ ] Vercel KV 数据库已创建并关联
- [ ] 项目已重新部署
- [ ] 前端按钮功能测试通过
- [ ] 定时任务配置完成（可选）

## 🎉 完成！

现在你的新闻联播投资分析系统已经：

✅ 成功部署到 Vercel  
✅ 使用 Vercel KV 云数据库存储数据  
✅ 支持前端按钮一键操作  
✅ 支持自动化定时任务  
✅ 数据持久化，永不丢失  

享受你的 AI 投资分析系统吧！🚀

---

**仓库地址**: https://github.com/yanhuicsdn/news-investment-analyzer

**问题反馈**: 请在 GitHub 提交 Issue
